<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anivers√°rio do Jo√£o - Transformers Adventure</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e, #0f1419);
            font-family: 'Arial Black', 'Arial', sans-serif;
            overflow: hidden;
            color: white;
            touch-action: none;
            user-select: none;
        }
        
        #gameContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }
        
        #gameCanvas {
            display: block;
            background: #000;
            border: 3px solid #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            max-width: 100%;
            max-height: 100vh;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #00ffff;
            font-size: 14px;
        }
        
        #gameOverScreen, #menuScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.95), rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 500;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
        
        /* Fundo animado do menu */
        #menuScreen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(0, 102, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(0, 255, 255, 0.05) 0%, transparent 50%);
            animation: backgroundPulse 4s ease-in-out infinite;
            z-index: -1;
        }
        
        @keyframes backgroundPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }
        
        #inviteModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #inviteContent {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            animation: glow 2s ease-in-out infinite alternate;
            border: 3px solid #ffd700;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            to { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); }
        }
        
        .menu-title {
            font-size: 4em;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 
                0 0 10px rgba(255, 215, 0, 0.8),
                0 0 20px rgba(255, 215, 0, 0.6),
                0 0 30px rgba(255, 215, 0, 0.4),
                3px 3px 0px #b8860b,
                6px 6px 0px rgba(0, 0, 0, 0.7);
            margin-bottom: 10px;
            animation: titlePulse 3s ease-in-out infinite;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        @keyframes titlePulse {
            0%, 100% { 
                transform: scale(1);
                text-shadow: 
                    0 0 10px rgba(255, 215, 0, 0.8),
                    0 0 20px rgba(255, 215, 0, 0.6),
                    0 0 30px rgba(255, 215, 0, 0.4),
                    3px 3px 0px #b8860b;
            }
            50% { 
                transform: scale(1.05);
                text-shadow: 
                    0 0 15px rgba(255, 215, 0, 1),
                    0 0 25px rgba(255, 215, 0, 0.8),
                    0 0 35px rgba(255, 215, 0, 0.6),
                    3px 3px 0px #b8860b,
                    0 0 40px rgba(255, 255, 255, 0.3);
            }
        }
        
        .menu-subtitle {
            font-size: 1.8em;
            color: #00ffff;
            margin-bottom: 20px;
            text-shadow: 
                0 0 10px rgba(0, 255, 255, 0.8),
                2px 2px 4px rgba(0, 0, 0, 0.8);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .menu-hero-name {
            font-size: 5em;
            font-weight: 900;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin: 20px 0;
            letter-spacing: 4px;
            text-transform: uppercase;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .menu-age {
            font-size: 3em;
            color: #ff6b6b;
            font-weight: 900;
            text-shadow: 
                0 0 10px rgba(255, 107, 107, 0.8),
                2px 2px 4px rgba(0, 0, 0, 0.8);
            margin: 10px 0;
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .menu-objectives {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ffff;
            border-radius: 15px;
            padding: 20px;
            margin: 30px 0;
            backdrop-filter: blur(10px);
        }
        
        .menu-objectives h3 {
            color: #00ffff;
            font-size: 1.4em;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .objective-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 1.1em;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .objective-icon {
            font-size: 1.5em;
            margin-right: 10px;
            animation: iconGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes iconGlow {
            from { text-shadow: 0 0 5px currentColor; }
            to { text-shadow: 0 0 15px currentColor, 0 0 25px currentColor; }
        }
        
        .menu-btn, .game-btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            background-size: 300% 300%;
            color: white;
            border: 3px solid #ffd700;
            padding: 20px 40px;
            font-size: 1.3em;
            border-radius: 15px;
            cursor: pointer;
            margin: 15px;
            transition: all 0.3s;
            font-weight: 900;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: buttonGradient 4s ease-in-out infinite;
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        @keyframes buttonGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .menu-btn:hover, .game-btn:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 
                0 8px 25px rgba(255, 215, 0, 0.4),
                0 0 30px rgba(255, 215, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border-color: #ffed4e;
        }
        
        .menu-btn:active, .game-btn:active {
            transform: scale(1.05) translateY(-2px);
        }
        
        .birthday-title {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 20px;
        }
        
        .invite-text {
            font-size: 1.3em;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            margin: 10px 0;
        }
        
        .game-over-title {
            font-size: 2.5em;
            color: #ff4757;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .game-over-stats {
            font-size: 1.2em;
            color: #00ffff;
            margin: 10px 0;
        }
        
        .instructions {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 15px;
            border: 2px solid #00ffff;
            color: #00ffff;
            font-size: 12px;
            text-align: center;
            max-width: 90%;
        }
        
        #mobileControls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: none;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
            z-index: 200;
        }
        
        .control-pad {
            display: grid;
            grid-template-columns: 60px 60px 60px;
            grid-template-rows: 60px 60px 60px;
            gap: 5px;
            pointer-events: auto;
        }
        
        .control-btn {
            background: rgba(0, 255, 255, 0.7);
            border: 2px solid #00ffff;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            transition: all 0.1s;
            cursor: pointer;
        }
        
        .control-btn:active {
            background: rgba(0, 255, 255, 1);
            transform: scale(0.95);
        }
        
        .control-btn.empty {
            background: transparent;
            border: none;
        }
        
        .shoot-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 215, 0, 0.7);
            border: 3px solid #ffd700;
            border-radius: 50%;
            color: #000;
            font-weight: bold;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            user-select: none;
            transition: all 0.1s;
            cursor: pointer;
        }
        
        .shoot-btn:active {
            background: rgba(255, 215, 0, 1);
            transform: scale(0.95);
        }
        
        @media (max-width: 768px) {
            #mobileControls {
                display: flex;
            }
            
            .menu-title {
                font-size: 2.5em;
            }
            
            .menu-hero-name {
                font-size: 3.5em;
            }
            
            .menu-age {
                font-size: 2.2em;
            }
            
            .menu-subtitle {
                font-size: 1.4em;
            }
            
            .menu-objectives {
                padding: 15px;
                margin: 20px 10px;
            }
            
            .objective-item {
                font-size: 1em;
            }
            
            .menu-btn, .game-btn {
                padding: 15px 25px;
                font-size: 1.1em;
            }
        }
        
        @media (max-width: 480px) {
            .menu-title {
                font-size: 2em;
            }
            
            .menu-hero-name {
                font-size: 2.8em;
            }
            
            .menu-age {
                font-size: 1.8em;
            }
            
            .menu-subtitle {
                font-size: 1.2em;
            }
            
            .menu-objectives h3 {
                font-size: 1.2em;
            }
            
            .objective-item {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <!-- Menu Screen -->
    <div id="menuScreen">
        <div class="menu-title">ü§ñ TRANSFORMERS ü§ñ</div>
        
        <div class="menu-hero-name">JO√ÉO</div>
        <div class="menu-age">10 ANOS</div>
        
        <div class="menu-subtitle">VENHA COMEMORAR!</div>
        
        <div class="menu-objectives">
            <h3>üéØ MISS√ÉO √âPICA:</h3>
            <div class="objective-item">
                <span class="objective-icon">‚≠ê</span>
                <span>Colete 20 cristais azuis de Energon</span>
            </div>
            <div class="objective-item">
                <span class="objective-icon">üéØ</span>
                <span>Destrua 10 Decepticons malvados</span>
            </div>
            <div class="objective-item">
                <span class="objective-icon">üåü</span>
                <span>Encontre os cristais "JO√ÉO 10 ANOS"</span>
            </div>
            <div class="objective-item">
                <span class="objective-icon">üéÅ</span>
                <span>Descubra o convite especial!</span>
            </div>
        </div>
        
        <button class="menu-btn" id="startBtn">‚ö° INICIAR MISS√ÉO ‚ö°</button>
        
        <div style="margin-top: 30px; font-size: 14px; color: #888; text-align: center;">
            <div style="color: #ffd700; font-weight: bold;">
                üéµ M√∫sica √©pica e sons ser√£o ativados quando iniciar o jogo üéµ
            </div>
            <div style="margin-top: 10px; color: #00ffff;">
                üìÖ 14/09 ‚Ä¢ domingo ‚Ä¢ Shopping Internacional
            </div>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="gameOverScreen" style="display: none;">
        <div class="game-over-title">üíÄ MISS√ÉO FALHOU üíÄ</div>
        <div class="game-over-stats">
            <div>üéØ Pontos Finais: <span id="finalScore">0</span></div>
            <div>üíé Cristais Coletados: <span id="finalCrystals">0</span>/20</div>
            <div>ü§ñ Decepticons Destru√≠dos: <span id="finalDecepticons">0</span>/10</div>
        </div>
        <button class="game-btn" id="restartBtn">TENTAR NOVAMENTE</button>
        <button class="game-btn" id="menuBtn">VOLTAR AO MENU</button>
    </div>
    
    <div id="ui">
        <div>üéØ Pontos: <span id="score">0</span></div>
        <div>üíñ Vidas: <span id="lives">3</span></div>
        <div>‚ö° Energia: <span id="energon">100</span></div>
        <div id="crystalDisplay">üèÜ Cristais: <span id="crystals">0</span>/20</div>
        <div>ü§ñ Decepticons: <span id="decepticons">0</span>/10</div>
    </div>
    
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>
    
    <div class="instructions">
        Use WASD ou setas para mover | ESPA√áO para atirar | Complete todas as fases para o convite!
    </div>
    
    <div id="mobileControls">
        <div class="control-pad">
            <div class="control-btn empty"></div>
            <div class="control-btn" data-key="w">‚Üë</div>
            <div class="control-btn empty"></div>
            <div class="control-btn" data-key="a">‚Üê</div>
            <div class="control-btn empty"></div>
            <div class="control-btn" data-key="d">‚Üí</div>
            <div class="control-btn empty"></div>
            <div class="control-btn" data-key="s">‚Üì</div>
            <div class="control-btn empty"></div>
        </div>
        <div class="shoot-btn" data-key=" ">üí•</div>
    </div>
    
    <div id="inviteModal">
        <div id="inviteContent">
            <div class="birthday-title">üéâ CONVITE ESPECIAL üéâ</div>
            <div class="invite-text">ü§ñ JO√ÉO VAI FAZER 10 ANOS! ü§ñ</div>
            <div class="invite-text">üìÖ Data: 14 de Setembro</div>
            <div class="invite-text">‚è∞ Hor√°rio: 11h30</div>
            <div class="invite-text">üìç Local: Neo Geo Shopping</div>
            <div class="invite-text">Internacional Guarulhos</div>
            <div class="invite-text" style="margin-top: 20px; font-size: 1.1em;">
                üéà Venha celebrar com os Transformers! üéà
            </div>
            <div class="invite-text" style="color: #ffd700;">
                ‚≠ê Ser√° uma festa √âPICA! ‚≠ê
            </div>
            <button class="game-btn" id="closeInviteBtn">AUTOBOTS, ROLL OUT! üöó</button>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let currentState = 'menu';
        let scrollOffset = 0;
        let audioEnabled = false;
        let musicPlaying = false;
        let audioContext = null;
        let backgroundAudio = null; // Para o arquivo de √°udio externo
        
        // Game state
        const gameState = {
            player: { x: 100, y: 300, width: 32, height: 32, vx: 0, vy: 0 },
            enemies: [],
            bullets: [],
            crystals: [],
            specialCrystals: [],
            particles: [],
            platforms: [],
            specialItems: [],
            score: 0,
            lives: 3,
            energon: 100,
            crystalsCollected: 0,
            specialCrystalsCollected: 0,
            decepticonsDestroyed: 0,
            keys: {},
            lastShot: 0,
            invulnerable: 0,
            lastCrystalSpawn: 0,
            totalCrystalsSpawned: 0,
            phase: 'normal',
            specialCrystalsSpawned: false
        };
        
        const colors = {
            autobot: '#0066ff',
            decepticon: '#ff0000',
            bullet: '#ffff00',
            crystal: '#00ffff',
            specialCrystal: '#00ff00',
            explosion: ['#ff4500', '#ff6347', '#ffa500'],
            platform: '#666666',
            specialItem: '#ffd700'
        };
        
        // Audio functions
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioEnabled = true;
                
                // Criar o √°udio de fundo com a m√∫sica fornecida
                backgroundAudio = new Audio('https://diego-malga.github.io/audio.mp3');
                backgroundAudio.loop = true;
                backgroundAudio.volume = 0.5; // Volume balanceado
                backgroundAudio.preload = 'auto';
                
                // Eventos para controle do √°udio
                backgroundAudio.addEventListener('canplaythrough', () => {
                    console.log('M√∫sica carregada e pronta para tocar!');
                });
                
                backgroundAudio.addEventListener('error', (e) => {
                    console.log('Erro ao carregar m√∫sica:', e);
                    backgroundAudio = null;
                    // Fallback para m√∫sica gerada se houver erro
                });
                
                backgroundAudio.addEventListener('ended', () => {
                    if (musicPlaying) {
                        backgroundAudio.currentTime = 0;
                        backgroundAudio.play();
                    }
                });
                
            } catch(e) {
                console.log('Audio not supported:', e);
                audioEnabled = false;
            }
        }
        
        function playSound(type) {
            if (!audioEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'laser':
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.type = 'sawtooth';
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                case 'explosion':
                    oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(20, audioContext.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.type = 'square';
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                case 'collect':
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.25, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.type = 'sine';
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                case 'special':
                    const frequencies = [523, 659, 784, 1047];
                    frequencies.forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.1);
                        gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.1 + 0.2);
                        osc.type = 'triangle';
                        osc.start(audioContext.currentTime + i * 0.1);
                        osc.stop(audioContext.currentTime + i * 0.1 + 0.2);
                    });
                    break;
            }
        }
        
        function startBackgroundMusic() {
            if (!audioEnabled) return;
            
            // Tentar tocar a m√∫sica do link https://diego-malga.github.io/audio.mp3
            if (backgroundAudio && !musicPlaying) {
                musicPlaying = true;
                
                // Promise para lidar com pol√≠ticas de autoplay do navegador
                const playPromise = backgroundAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('‚úÖ M√∫sica de fundo iniciada com sucesso!');
                    }).catch(error => {
                        console.log('‚ùå Erro de autoplay, m√∫sica ser√° iniciada ap√≥s intera√ß√£o:', error);
                        // A m√∫sica ser√° iniciada na pr√≥xima intera√ß√£o do usu√°rio
                    });
                }
            } else if (!backgroundAudio && !musicPlaying) {
                // Fallback para m√∫sica gerada se n√£o conseguir carregar o arquivo
                console.log('üéµ Usando m√∫sica gerada como fallback');
                playGeneratedMusic();
            }
        }
        
        function playGeneratedMusic() {
            if (!audioEnabled || musicPlaying) return;
            musicPlaying = true;
            playMusicLoop();
        }
        
        function playMusicLoop() {
            if (!musicPlaying || !audioContext) return;
            
            // M√∫sica super animada estilo Sonic/Mega Man - muito mais energ√©tica!
            const melody = [
                // Intro explosiva
                {freq: 523, duration: 0.15}, // C5
                {freq: 659, duration: 0.15}, // E5
                {freq: 784, duration: 0.15}, // G5
                {freq: 1047, duration: 0.15}, // C6
                {freq: 1319, duration: 0.3}, // E6
                
                // Sequ√™ncia r√°pida e animada
                {freq: 1047, duration: 0.15}, // C6
                {freq: 988, duration: 0.15},  // B5
                {freq: 880, duration: 0.15},  // A5
                {freq: 784, duration: 0.15},  // G5
                {freq: 659, duration: 0.15},  // E5
                {freq: 784, duration: 0.15},  // G5
                {freq: 880, duration: 0.15},  // A5
                {freq: 1047, duration: 0.3},  // C6
                
                // Parte super energ√©tica
                {freq: 1175, duration: 0.15}, // D6
                {freq: 1319, duration: 0.15}, // E6
                {freq: 1397, duration: 0.15}, // F6
                {freq: 1568, duration: 0.15}, // G6
                {freq: 1760, duration: 0.3},  // A6
                
                // Descida √©pica
                {freq: 1568, duration: 0.15}, // G6
                {freq: 1397, duration: 0.15}, // F6
                {freq: 1319, duration: 0.15}, // E6
                {freq: 1175, duration: 0.15}, // D6
                {freq: 1047, duration: 0.15}, // C6
                {freq: 880, duration: 0.15},  // A5
                {freq: 784, duration: 0.15},  // G5
                {freq: 659, duration: 0.3},   // E5
                
                // Final poderoso
                {freq: 523, duration: 0.15}, // C5
                {freq: 659, duration: 0.15}, // E5
                {freq: 784, duration: 0.15}, // G5
                {freq: 1047, duration: 0.45}, // C6 - sustentado
            ];
            
            // Contra-melodia super r√°pida para mais energia
            const counterMelody = [
                {freq: 1047, duration: 0.1}, {freq: 1175, duration: 0.1}, {freq: 1319, duration: 0.1},
                {freq: 1175, duration: 0.1}, {freq: 1047, duration: 0.1}, {freq: 880, duration: 0.1},
                {freq: 1047, duration: 0.1}, {freq: 1175, duration: 0.1}, {freq: 1319, duration: 0.1},
                {freq: 1397, duration: 0.1}, {freq: 1568, duration: 0.1}, {freq: 1760, duration: 0.1},
                {freq: 1568, duration: 0.1}, {freq: 1397, duration: 0.1}, {freq: 1319, duration: 0.1},
                {freq: 1175, duration: 0.1}, {freq: 1047, duration: 0.1}, {freq: 880, duration: 0.1},
                {freq: 784, duration: 0.1}, {freq: 659, duration: 0.1}, {freq: 523, duration: 0.1},
                {freq: 659, duration: 0.1}, {freq: 784, duration: 0.1}, {freq: 1047, duration: 0.2},
            ];
            
            // Linha de baixo muito mais r√°pida e energ√©tica
            const bassLine = [
                {freq: 131, duration: 0.2}, // C3
                {freq: 165, duration: 0.2}, // E3
                {freq: 196, duration: 0.2}, // G3
                {freq: 131, duration: 0.2}, // C3
                {freq: 147, duration: 0.2}, // D3
                {freq: 165, duration: 0.2}, // E3
                {freq: 175, duration: 0.2}, // F3
                {freq: 196, duration: 0.2}, // G3
                {freq: 220, duration: 0.2}, // A3
                {freq: 196, duration: 0.2}, // G3
                {freq: 175, duration: 0.2}, // F3
                {freq: 165, duration: 0.2}, // E3
                {freq: 147, duration: 0.2}, // D3
                {freq: 131, duration: 0.4}, // C3
            ];
            
            // Tocar melodia principal com mais punch
            let time = 0;
            melody.forEach((note, i) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime + time);
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime + time);
                gainNode.gain.linearRampToValueAtTime(0.12, audioContext.currentTime + time + 0.005);
                gainNode.gain.exponentialRampToValueAtTime(0.03, audioContext.currentTime + time + note.duration * 0.7);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + note.duration);
                
                oscillator.start(audioContext.currentTime + time);
                oscillator.stop(audioContext.currentTime + time + note.duration);
                
                time += note.duration;
            });
            
            // Tocar contra-melodia para mais densidade
            let counterTime = 0.3; // Come√ßa um pouco depois
            counterMelody.forEach((note, i) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime + counterTime);
                oscillator.type = 'sawtooth'; // Som diferente para distinguir
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime + counterTime);
                gainNode.gain.linearRampToValueAtTime(0.06, audioContext.currentTime + counterTime + 0.005);
                gainNode.gain.exponentialRampToValueAtTime(0.02, audioContext.currentTime + counterTime + note.duration * 0.8);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + counterTime + note.duration);
                
                oscillator.start(audioContext.currentTime + counterTime);
                oscillator.stop(audioContext.currentTime + counterTime + note.duration);
                
                counterTime += note.duration;
            });
            
            // Baixo energ√©tico
            let bassTime = 0;
            bassLine.forEach((note, i) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime + bassTime);
                oscillator.type = 'triangle';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime + bassTime);
                gainNode.gain.linearRampToValueAtTime(0.08, audioContext.currentTime + bassTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.02, audioContext.currentTime + bassTime + note.duration * 0.9);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + bassTime + note.duration);
                
                oscillator.start(audioContext.currentTime + bassTime);
                oscillator.stop(audioContext.currentTime + bassTime + note.duration);
                
                bassTime += note.duration;
            });
            
            // Bateria super r√°pida e energ√©tica
            const drumTimes = [];
            for (let i = 0; i < time; i += 0.15) {
                drumTimes.push(i);
            }
            
            drumTimes.forEach((drumTime, index) => {
                // Kick drum mais frequente
                if (index % 2 === 0) {
                    const kickOsc = audioContext.createOscillator();
                    const kickGain = audioContext.createGain();
                    
                    kickOsc.connect(kickGain);
                    kickGain.connect(audioContext.destination);
                    
                    kickOsc.frequency.setValueAtTime(80, audioContext.currentTime + drumTime);
                    kickOsc.frequency.exponentialRampToValueAtTime(40, audioContext.currentTime + drumTime + 0.08);
                    kickOsc.type = 'sine';
                    
                    kickGain.gain.setValueAtTime(0.18, audioContext.currentTime + drumTime);
                    kickGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + drumTime + 0.08);
                    
                    kickOsc.start(audioContext.currentTime + drumTime);
                    kickOsc.stop(audioContext.currentTime + drumTime + 0.08);
                }
                
                // Hi-hat constante para manter o ritmo
                const hihatOsc = audioContext.createOscillator();
                const hihatGain = audioContext.createGain();
                
                hihatOsc.connect(hihatGain);
                hihatGain.connect(audioContext.destination);
                
                hihatOsc.frequency.setValueAtTime(12000, audioContext.currentTime + drumTime);
                hihatOsc.type = 'square';
                
                hihatGain.gain.setValueAtTime(0.04, audioContext.currentTime + drumTime);
                hihatGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + drumTime + 0.03);
                
                hihatOsc.start(audioContext.currentTime + drumTime);
                hihatOsc.stop(audioContext.currentTime + drumTime + 0.03);
                
                // Snare nos contratempos
                if (index % 4 === 2) {
                    const snareOsc = audioContext.createOscillator();
                    const snareGain = audioContext.createGain();
                    
                    snareOsc.connect(snareGain);
                    snareGain.connect(audioContext.destination);
                    
                    snareOsc.frequency.setValueAtTime(200, audioContext.currentTime + drumTime);
                    snareOsc.frequency.exponentialRampToValueAtTime(150, audioContext.currentTime + drumTime + 0.1);
                    snareOsc.type = 'square';
                    
                    snareGain.gain.setValueAtTime(0.08, audioContext.currentTime + drumTime);
                    snareGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + drumTime + 0.1);
                    
                    snareOsc.start(audioContext.currentTime + drumTime);
                    snareOsc.stop(audioContext.currentTime + drumTime + 0.1);
                }
            });
            
            // Loop muito mais r√°pido para manter a energia m√°xima
            setTimeout(() => {
                if (musicPlaying) playMusicLoop();
            }, time * 1000 + 200); // Quase sem pausa!
        }
        
        function stopBackgroundMusic() {
            musicPlaying = false;
            
            // Parar m√∫sica do arquivo se estiver tocando
            if (backgroundAudio) {
                backgroundAudio.pause();
                backgroundAudio.currentTime = 0;
            }
        }
        
        // Game functions
        function initGame() {
            gameState.player = { x: 100, y: 300, width: 32, height: 32, vx: 0, vy: 0 };
            gameState.enemies = [];
            gameState.bullets = [];
            gameState.crystals = [];
            gameState.specialCrystals = [];
            gameState.particles = [];
            gameState.platforms = [];
            gameState.specialItems = [];
            gameState.score = 0;
            gameState.lives = 3;
            gameState.energon = 100;
            gameState.crystalsCollected = 0;
            gameState.specialCrystalsCollected = 0;
            gameState.decepticonsDestroyed = 0;
            gameState.keys = {};
            gameState.lastShot = 0;
            gameState.invulnerable = 0;
            gameState.lastCrystalSpawn = 0;
            gameState.totalCrystalsSpawned = 0;
            gameState.phase = 'normal';
            gameState.specialCrystalsSpawned = false;
            scrollOffset = 0;
            
            // Create platforms
            for (let i = 0; i < 20; i++) {
                gameState.platforms.push({
                    x: i * 100 + Math.random() * 50,
                    y: 500 + Math.random() * 50,
                    width: 80,
                    height: 20
                });
            }
            
            // Spawn initial enemies
            for (let i = 0; i < 3; i++) {
                spawnEnemy();
            }
            
            // Spawn initial crystals
            for (let i = 0; i < 10; i++) {
                spawnCrystal();
                gameState.totalCrystalsSpawned++;
            }
        }
        
        function spawnEnemy() {
            gameState.enemies.push({
                x: canvas.width + Math.random() * 200,
                y: Math.random() * (canvas.height - 32),
                width: 32,
                height: 32,
                vx: -2 - Math.random() * 2,
                vy: (Math.random() - 0.5) * 2,
                health: 2,
                lastShot: 0
            });
        }
        
        function spawnCrystal() {
            gameState.crystals.push({
                x: Math.random() * (canvas.width * 2) + canvas.width,
                y: Math.random() * (canvas.height - 32),
                width: 24,
                height: 24,
                rotation: 0,
                collected: false
            });
        }
        
        function spawnSpecialCrystal(x, y, letter) {
            gameState.specialCrystals.push({
                x: x,
                y: y,
                width: 24,
                height: 24,
                rotation: 0,
                collected: false,
                letter: letter,
                pulse: 0
            });
        }
        
        function createSpecialCrystalsFormation() {
            const formations = [
                { x: 900, y: 200, letter: 'J' },
                { x: 950, y: 200, letter: '√É' },
                { x: 1000, y: 200, letter: 'O' },
                { x: 1100, y: 200, letter: '1' },
                { x: 1150, y: 200, letter: '0' },
                { x: 1250, y: 200, letter: 'A' },
                { x: 1300, y: 200, letter: 'N' },
                { x: 1350, y: 200, letter: 'O' },
                { x: 1400, y: 200, letter: 'S' }
            ];
            
            formations.forEach(formation => {
                spawnSpecialCrystal(formation.x, formation.y, formation.letter);
            });
        }
        
        function spawnSpecialItem() {
            gameState.specialItems.push({
                x: canvas.width + 100,
                y: Math.random() * (canvas.height - 40),
                width: 32,
                height: 32,
                rotation: 0,
                collected: false,
                pulse: 0
            });
        }
        
        function createParticle(x, y, color) {
            for (let i = 0; i < 8; i++) {
                gameState.particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 30,
                    color: color
                });
            }
        }
        
        function shoot() {
            const now = Date.now();
            if (now - gameState.lastShot > 200) {
                gameState.bullets.push({
                    x: gameState.player.x + gameState.player.width,
                    y: gameState.player.y + gameState.player.height / 2,
                    width: 8,
                    height: 4,
                    vx: 8,
                    vy: 0
                });
                gameState.lastShot = now;
                playSound('laser');
            }
        }
        
        function takeDamage() {
            if (gameState.invulnerable > 0) return;
            
            gameState.energon -= 25;
            gameState.invulnerable = 120;
            
            createParticle(gameState.player.x + gameState.player.width/2, 
                          gameState.player.y + gameState.player.height/2, '#ff0000');
            
            if (gameState.energon <= 0) {
                gameState.lives--;
                gameState.energon = 100;
                
                if (gameState.lives <= 0) {
                    gameOver();
                } else {
                    gameState.player.x = 100;
                    gameState.player.y = 300;
                }
            }
        }
        
        function update() {
            if (currentState !== 'playing') return;
            
            scrollOffset += 1;
            
            // Spawn new crystals
            const now = Date.now();
            if (now - gameState.lastCrystalSpawn > 3000 && gameState.totalCrystalsSpawned < 50) {
                spawnCrystal();
                gameState.totalCrystalsSpawned++;
                gameState.lastCrystalSpawn = now;
            }
            
            // Phase transitions
            if (gameState.phase === 'normal' && gameState.crystalsCollected >= 20 && gameState.decepticonsDestroyed >= 10) {
                gameState.phase = 'special';
                if (!gameState.specialCrystalsSpawned) {
                    createSpecialCrystalsFormation();
                    gameState.specialCrystalsSpawned = true;
                }
            }
            
            if (gameState.phase === 'special' && gameState.specialCrystalsCollected >= 9 && gameState.specialItems.length === 0) {
                spawnSpecialItem();
                gameState.phase = 'complete';
            }
            
            if (gameState.invulnerable > 0) {
                gameState.invulnerable--;
            }
            
            // Player movement
            if (gameState.keys['a'] || gameState.keys['arrowleft']) {
                gameState.player.vx = -4;
            } else if (gameState.keys['d'] || gameState.keys['arrowright']) {
                gameState.player.vx = 4;
            } else {
                gameState.player.vx = 0;
            }
            
            if (gameState.keys['w'] || gameState.keys['arrowup']) {
                gameState.player.vy = -4;
            } else if (gameState.keys['s'] || gameState.keys['arrowdown']) {
                gameState.player.vy = 4;
            } else {
                gameState.player.vy = 0;
            }
            
            gameState.player.x += gameState.player.vx;
            gameState.player.y += gameState.player.vy;
            
            // Keep player in bounds
            gameState.player.x = Math.max(0, Math.min(canvas.width - gameState.player.width, gameState.player.x));
            gameState.player.y = Math.max(0, Math.min(canvas.height - gameState.player.height, gameState.player.y));
            
            // Update bullets
            gameState.bullets.forEach((bullet, index) => {
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;
                
                if (bullet.x > canvas.width || bullet.x < -bullet.width) {
                    gameState.bullets.splice(index, 1);
                }
            });
            
            // Update enemies
            gameState.enemies.forEach((enemy, index) => {
                enemy.x += enemy.vx - 1;
                enemy.y += enemy.vy;
                
                if (enemy.y <= 0 || enemy.y >= canvas.height - enemy.height) {
                    enemy.vy = -enemy.vy;
                }
                
                if (enemy.x < -enemy.width) {
                    gameState.enemies.splice(index, 1);
                    spawnEnemy();
                }
            });
            
            // Update platforms
            gameState.platforms.forEach(platform => {
                platform.x -= 1;
                if (platform.x < -platform.width) {
                    platform.x = canvas.width + Math.random() * 100;
                }
            });
            
            // Update crystals and special crystals
            gameState.crystals.forEach(crystal => {
                crystal.x -= 1;
                crystal.rotation += 0.1;
            });
            
            gameState.specialCrystals.forEach(crystal => {
                crystal.x -= 0.5;
                crystal.rotation += 0.05;
                crystal.pulse += 0.15;
            });
            
            gameState.specialItems.forEach(item => {
                item.x -= 1;
                item.rotation += 0.05;
                item.pulse += 0.2;
            });
            
            // Collision detection - bullets vs enemies
            gameState.bullets.forEach((bullet, bulletIndex) => {
                if (bullet.enemy) return;
                
                gameState.enemies.forEach((enemy, enemyIndex) => {
                    if (bullet.x < enemy.x + enemy.width &&
                        bullet.x + bullet.width > enemy.x &&
                        bullet.y < enemy.y + enemy.height &&
                        bullet.y + bullet.height > enemy.y) {
                        
                        enemy.health--;
                        gameState.bullets.splice(bulletIndex, 1);
                        createParticle(enemy.x + enemy.width/2, enemy.y + enemy.height/2, colors.explosion[0]);
                        
                        if (enemy.health <= 0) {
                            gameState.enemies.splice(enemyIndex, 1);
                            gameState.score += 100;
                            gameState.decepticonsDestroyed++;
                            playSound('explosion');
                            spawnEnemy();
                        }
                    }
                });
            });
            
            // Collision detection - enemies vs player
            gameState.enemies.forEach(enemy => {
                if (gameState.player.x < enemy.x + enemy.width &&
                    gameState.player.x + gameState.player.width > enemy.x &&
                    gameState.player.y < enemy.y + enemy.height &&
                    gameState.player.y + gameState.player.height > enemy.y) {
                    
                    takeDamage();
                }
            });
            
            // Crystal collection
            gameState.crystals.forEach(crystal => {
                if (crystal.collected) return;
                
                if (gameState.player.x < crystal.x + crystal.width &&
                    gameState.player.x + gameState.player.width > crystal.x &&
                    gameState.player.y < crystal.y + crystal.height &&
                    gameState.player.y + gameState.player.height > crystal.y) {
                    
                    crystal.collected = true;
                    gameState.crystalsCollected++;
                    gameState.score += 500;
                    createParticle(crystal.x + crystal.width/2, crystal.y + crystal.height/2, colors.crystal);
                    playSound('collect');
                }
            });
            
            // Special crystal collection
            gameState.specialCrystals.forEach(crystal => {
                if (crystal.collected) return;
                
                if (gameState.player.x < crystal.x + crystal.width &&
                    gameState.player.x + gameState.player.width > crystal.x &&
                    gameState.player.y < crystal.y + crystal.height &&
                    gameState.player.y + gameState.player.height > crystal.y) {
                    
                    crystal.collected = true;
                    gameState.specialCrystalsCollected++;
                    gameState.score += 1000;
                    createParticle(crystal.x + crystal.width/2, crystal.y + crystal.height/2, colors.specialCrystal);
                    playSound('collect');
                }
            });
            
            // Special item collection
            gameState.specialItems.forEach(item => {
                if (item.collected) return;
                
                if (gameState.player.x < item.x + item.width &&
                    gameState.player.x + gameState.player.width > item.x &&
                    gameState.player.y < item.y + item.height &&
                    gameState.player.y + gameState.player.height > item.y) {
                    
                    item.collected = true;
                    gameState.score += 2000;
                    createParticle(item.x + item.width/2, item.y + item.height/2, colors.specialItem);
                    playSound('special');
                    showInvite();
                }
            });
            
            // Update particles
            gameState.particles.forEach((particle, index) => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.life--;
                
                if (particle.life <= 0) {
                    gameState.particles.splice(index, 1);
                }
            });
            
            updateUI();
        }
        
        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('lives').textContent = gameState.lives;
            document.getElementById('energon').textContent = gameState.energon;
            document.getElementById('decepticons').textContent = gameState.decepticonsDestroyed;
            
            const crystalDisplay = document.getElementById('crystalDisplay');
            if (gameState.phase === 'special') {
                crystalDisplay.innerHTML = `üåü Cristais Especiais: <span id="crystals">${gameState.specialCrystalsCollected}</span>/9`;
            } else {
                crystalDisplay.innerHTML = `üèÜ Cristais: <span id="crystals">${gameState.crystalsCollected}</span>/20`;
            }
        }
        
        function render() {
            // Clear canvas
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw stars
            for (let i = 0; i < 50; i++) {
                const x = (i * 137 + scrollOffset * 0.5) % canvas.width;
                const y = (i * 73) % canvas.height;
                const brightness = Math.sin(Date.now() * 0.001 + i) * 0.5 + 0.5;
                ctx.fillStyle = `rgba(255, 255, 255, ${brightness})`;
                ctx.fillRect(x, y, 1, 1);
            }
            
            // Draw platforms
            gameState.platforms.forEach(platform => {
                ctx.fillStyle = colors.platform;
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            });
            
            // Draw player
            if (gameState.invulnerable === 0 || Math.floor(gameState.invulnerable / 10) % 2 === 0) {
                ctx.fillStyle = colors.autobot;
                ctx.fillRect(gameState.player.x, gameState.player.y, gameState.player.width, gameState.player.height);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(gameState.player.x + 8, gameState.player.y + 8, 16, 16);
            }
            
            // Draw enemies
            gameState.enemies.forEach(enemy => {
                ctx.fillStyle = colors.decepticon;
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(enemy.x + 8, enemy.y + 8, 16, 16);
            });
            
            // Draw bullets
            gameState.bullets.forEach(bullet => {
                ctx.fillStyle = bullet.enemy ? '#ff0000' : colors.bullet;
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            });
            
            // Draw normal crystals
            gameState.crystals.forEach(crystal => {
                if (crystal.collected) return;
                
                ctx.save();
                ctx.translate(crystal.x + crystal.width/2, crystal.y + crystal.height/2);
                ctx.rotate(crystal.rotation);
                
                ctx.fillStyle = colors.crystal;
                ctx.fillRect(-crystal.width/2, -crystal.height/2, crystal.width, crystal.height);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(-crystal.width/4, -crystal.height/4, crystal.width/2, crystal.height/2);
                
                ctx.restore();
            });
            
            // Draw special crystals
            gameState.specialCrystals.forEach(crystal => {
                if (crystal.collected) return;
                
                ctx.save();
                ctx.translate(crystal.x + crystal.width/2, crystal.y + crystal.height/2);
                ctx.rotate(crystal.rotation);
                
                const glowIntensity = Math.sin(crystal.pulse) * 0.5 + 0.7;
                ctx.fillStyle = colors.specialCrystal;
                ctx.fillRect(-crystal.width/2, -crystal.height/2, crystal.width, crystal.height);
                ctx.fillStyle = '#88ff88';
                ctx.fillRect(-crystal.width/3, -crystal.height/3, crystal.width * 2/3, crystal.height * 2/3);
                
                ctx.restore();
                
                // Draw letter
                ctx.fillStyle = colors.specialCrystal;
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(crystal.letter, crystal.x + crystal.width/2, crystal.y - 10);
                ctx.textAlign = 'left';
            });
            
            // Draw special items
            gameState.specialItems.forEach(item => {
                if (item.collected) return;
                
                ctx.save();
                ctx.translate(item.x + item.width/2, item.y + item.height/2);
                ctx.rotate(item.rotation);
                
                const glowIntensity = Math.sin(item.pulse) * 0.5 + 0.7;
                ctx.fillStyle = colors.specialItem;
                ctx.fillRect(-item.width/2, -item.height/2, item.width, item.height);
                ctx.fillStyle = '#ffff88';
                ctx.fillRect(-item.width/3, -item.height/3, item.width * 2/3, item.height * 2/3);
                
                ctx.restore();
                
                ctx.fillStyle = colors.specialItem;
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üéÅ CONVITE!', item.x + item.width/2, item.y - 10);
                ctx.textAlign = 'left';
            });
            
            // Draw particles
            gameState.particles.forEach(particle => {
                ctx.fillStyle = particle.color;
                ctx.globalAlpha = particle.life / 30;
                ctx.fillRect(particle.x, particle.y, 3, 3);
                ctx.globalAlpha = 1;
            });
            
            // Draw phase indicator
            if (gameState.phase === 'special') {
                ctx.fillStyle = colors.specialCrystal;
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üåü FASE ESPECIAL - COLETE AS LETRAS! üåü', canvas.width/2, 50);
                ctx.textAlign = 'left';
            } else if (gameState.phase === 'complete') {
                ctx.fillStyle = colors.specialItem;
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üéÅ PROCURE O CONVITE ESPECIAL! üéÅ', canvas.width/2, 50);
                ctx.textAlign = 'left';
            }
        }
        
        function gameLoop() {
            if (currentState === 'playing') {
                update();
            }
            render();
            requestAnimationFrame(gameLoop);
        }
        
        // Menu functions
        function startGame() {
            initAudio();
            
            // Aguardar um pouco para o √°udio carregar antes de tentar tocar
            setTimeout(() => {
                startBackgroundMusic();
            }, 100);
            
            currentState = 'playing';
            document.getElementById('menuScreen').style.display = 'none';
            initGame();
        }
        
        function gameOver() {
            currentState = 'gameOver';
            stopBackgroundMusic();
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalCrystals').textContent = gameState.crystalsCollected;
            document.getElementById('finalDecepticons').textContent = gameState.decepticonsDestroyed;
            document.getElementById('gameOverScreen').style.display = 'flex';
        }
        
        function restartGame() {
            document.getElementById('gameOverScreen').style.display = 'none';
            currentState = 'playing';
            
            // Reiniciar m√∫sica se parou
            if (backgroundAudio && !musicPlaying) {
                startBackgroundMusic();
            } else if (!backgroundAudio) {
                startBackgroundMusic();
            }
            
            initGame();
        }
        
        function backToMenu() {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('menuScreen').style.display = 'flex';
            stopBackgroundMusic();
            currentState = 'menu';
        }
        
        function showInvite() {
            document.getElementById('inviteModal').style.display = 'flex';
        }
        
        function closeInvite() {
            document.getElementById('inviteModal').style.display = 'none';
            // Reset for replay
            gameState.crystalsCollected = 0;
            gameState.specialCrystalsCollected = 0;
            gameState.decepticonsDestroyed = 0;
            gameState.crystals.forEach(crystal => crystal.collected = false);
            gameState.specialCrystals.forEach(crystal => crystal.collected = false);
            gameState.specialItems = [];
            gameState.totalCrystalsSpawned = 10;
            gameState.phase = 'normal';
            gameState.specialCrystalsSpawned = false;
            
            gameState.crystals = gameState.crystals.filter(crystal => crystal.x > -100);
            gameState.specialCrystals = [];
            while (gameState.crystals.length < 10) {
                spawnCrystal();
                gameState.totalCrystalsSpawned++;
            }
            
            currentState = 'playing';
        }
        
        // Input handling
        document.addEventListener('keydown', (e) => {
            if (currentState === 'playing') {
                gameState.keys[e.key.toLowerCase()] = true;
                if (e.key === ' ') {
                    e.preventDefault();
                    shoot();
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            gameState.keys[e.key.toLowerCase()] = false;
        });
        
        // Mobile controls
        const controlBtns = document.querySelectorAll('.control-btn[data-key]');
        const shootBtn = document.querySelector('.shoot-btn');
        
        controlBtns.forEach(btn => {
            const key = btn.getAttribute('data-key');
            
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (currentState === 'playing') {
                    gameState.keys[key] = true;
                }
            });
            
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                gameState.keys[key] = false;
            });
        });
        
        shootBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (currentState === 'playing') {
                shoot();
            }
        });
        
        // Button event listeners
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', restartGame);
        document.getElementById('menuBtn').addEventListener('click', backToMenu);
        document.getElementById('closeInviteBtn').addEventListener('click', closeInvite);
        
        // Responsive canvas
        function resizeCanvas() {
            const maxWidth = window.innerWidth - 20;
            const maxHeight = window.innerHeight - 100;
            
            const scaleX = maxWidth / 800;
            const scaleY = maxHeight / 600;
            const scale = Math.min(scaleX, scaleY, 1);
            
            canvas.style.width = (800 * scale) + 'px';
            canvas.style.height = (600 * scale) + 'px';
            
            if ('ontouchstart' in window || window.innerWidth <= 768) {
                document.getElementById('mobileControls').style.display = 'flex';
            }
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // Start the game loop
        updateUI();
        gameLoop();
    </script>
</body>
</html>
